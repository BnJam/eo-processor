name: Build and Publish Wheels

on:
  push:
    branches: [main]

env:
  # The environment for PyPI publishing (used in the final publish step)
  PYPI_ENVIRONMENT: pypi

permissions:
  contents: write # Required for the version-bump job to commit and tag
  id-token: write # Required for maturin to publish to PyPI securely via OIDC

jobs:
  # ----------------------------------------------------
  # JOB 1: VERSION BUMP, COMMIT, AND TAG
  # ----------------------------------------------------
  version-bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push commits and tags
      pull-requests: read # Required to read PR labels via gh CLI
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      version_changed: ${{ steps.bump.outputs.version_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch depth 0 needed for full history access for version bump logic
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv and GitHub CLI
        run: |
          pip install uv
          # Install gh CLI for interacting with PR data
          sudo apt-get update && sudo apt-get install -y gh

      - name: Install Dependencies for version script
        run: |
          # Sync dev dependencies to ensure the version script's dependencies are met
          uv pip install maturin ".[dev]"

      - name: Determine version increment, Commit, and Tag
        id: bump
        # NOTE: You MUST ensure your Python version script (scripts/version.py)
        # also updates the version in Cargo.toml for the Rust code,
        # otherwise maturin will build with the old version number!
        # Assuming your script now handles both: pyproject.toml and Cargo.toml
        run: |
          # The logic below is identical to your existing script
          # -------------------------------------------------------
          MERGE_MSG=$(git log -1 --pretty=format:"%s")
          echo "Merge message: $MERGE_MSG"
          PR_NUM=$(echo "$MERGE_MSG" | grep -oP "Merge pull request #\K\d+" || echo "")

          if [ -z "$PR_NUM" ]; then
            echo "No PR number found in merge commit, skipping version bump"
            echo "version_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found PR #$PR_NUM"
          BRANCH_NAME=$(gh pr view $PR_NUM --json headRefName --jq '.headRefName')
          LABELS=$(gh pr view $PR_NUM --json labels --jq '.labels[].name' | tr '\n' ' ')
          echo "Branch name: $BRANCH_NAME"
          echo "PR labels: $LABELS"

          INCREMENT_TYPE=""
          if echo "$LABELS" | grep -q "bump:none"; then
            INCREMENT_TYPE=""
          elif echo "$LABELS" | grep -q "bump:major\|bump:release"; then
            INCREMENT_TYPE="major"
          elif echo "$LABELS" | grep -q "bump:minor\|bump:feature"; then
            INCREMENT_TYPE="minor"
          elif echo "$LABELS" | grep -q "bump:patch\|bump:hotfix"; then
            INCREMENT_TYPE="patch"
          elif [[ "$BRANCH_NAME" == hotfix/* ]] || [[ "$BRANCH_NAME" == copilot/fix-* ]] || [[ "$BRANCH_NAME" == copilot/hotfix/* ]] || [[ "$BRANCH_NAME" == fix/* ]]; then
            INCREMENT_TYPE="patch"
          elif [[ "$BRANCH_NAME" == feature/* ]] || [[ "$BRANCH_NAME" == copilot/feature/* ]]; then
            INCREMENT_TYPE="minor"
          elif [[ "$BRANCH_NAME" == release/* ]] || [[ "$BRANCH_NAME" == copilot/release/* ]]; then
            INCREMENT_TYPE="major"
          fi

          if [ -z "$INCREMENT_TYPE" ]; then
            echo "No version bump label or recognized branch prefix found, skipping version bump"
            echo "version_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Version increment type: $INCREMENT_TYPE"
          CURRENT_VERSION=$(python scripts/version.py current | cut -d' ' -f3)
          echo "Current version: $CURRENT_VERSION"

          # Increment version (This must update pyproject.toml AND Cargo.toml)
          python scripts/version.py $INCREMENT_TYPE
          NEW_VERSION=$(python scripts/version.py current | cut -d' ' -f3)

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_changed=true" >> $GITHUB_OUTPUT

          # Configure git for commit
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Commit version changes (must include pyproject.toml and Cargo.toml)
          git add pyproject.toml Cargo.toml
          # Add any other files updated by your version script (e.g., __init__.py)
          git commit -m "chore: bump version to $NEW_VERSION (auto-increment from $BRANCH_NAME branch)"

          # Pull latest changes from main to avoid push conflicts
          git pull --rebase --autostash origin main || (git fetch origin main && git rebase origin/main)

          # Push the version bump commit
          git push

          # Create and push tag
          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------------------
  # JOB 2: BUILD AND PUBLISH TO PYPI
  # ----------------------------------------------------
  pypi-publish:
    runs-on: ubuntu-latest
    needs: [version-bump]
    if: needs.version-bump.outputs.version_changed == 'true'
    environment:
      name: ${{ env.PYPI_ENVIRONMENT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch the latest commit which contains the version bump and tag
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install maturin
        run: pip install maturin

      - name: üèóÔ∏è Build All Wheels and Source Distribution
        # maturin builds for all major platforms (Linux/macOS/Windows) and Python versions
        run: maturin build --release --manylinux auto --universal2

      - name: üöÄ Publish to PyPI
        # Uses maturin's built-in publishing command with OIDC (OpenID Connect)
        run: maturin publish --skip-existing

  # ----------------------------------------------------
  # JOB 3: CREATE GITHUB RELEASE
  # ----------------------------------------------------
  github-release:
    runs-on: ubuntu-latest
    needs: [version-bump, pypi-publish] # Wait for both version bump and PyPI publish to ensure everything is ready
    permissions:
      contents: write
    if: needs.version-bump.outputs.version_changed == 'true'
    steps:
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ needs.version-bump.outputs.new_version }}
          name: "Release v${{ needs.version-bump.outputs.new_version }}"
          # A minimal body for the release, you could extend this
          body: |
            ## üéâ New Release: v${{ needs.version-bump.outputs.new_version }}

            This release was automatically generated after a successful CI/CD pipeline.
          token: ${{ secrets.GITHUB_TOKEN }}
