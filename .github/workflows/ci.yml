name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Tests via tox (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      # --- RUST TOOLCHAIN SETUP ---
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv and tools
        uses: astral-sh/setup-uv@v3

      - name: Sync dependencies (dev + extras)
        # This step will install maturin (assuming it's in your dev dependencies)
        run: uv sync --all-extras --dev

      # --- LINT STEP ---
      - name: ðŸ”Ž Run Rust Checks (Clippy & Fmt)
        # Ensure Rust code is formatted and linted before building
        run: |
          cargo fmt --check
          cargo clippy --tests -- -D warnings

      - name: Lint (Ruff)
        id: lint_step
        continue-on-error: false
        run: |
          echo "Running Ruff Linting and Formatting..."
          uv run ruff format python/eo_processor/ tests/
          uv run ruff check python/eo_processor/ tests/ --fix --no-cache

      # --- BUILD STEP (Changed to Maturin) ---
      - name: Install tox
        run: pip install tox tox-gh-actions

      # --- TESTS + COVERAGE STEPS ---
      - name: Run lint (tox)
        run: tox -e lint
      - name: Run Rust clippy (tox)
        run: tox -e clippy || echo "Clippy env optional; ensure Rust toolchain installed."
      - name: Run tests (tox)
        run: tox -e py${{ matrix.python-version }}
      - name: Generate coverage (only on 3.12)
        if: matrix.python-version == '3.12'
        run: |
          pip install coverage
          coverage run -m pytest -q
          coverage report
          coverage xml
      - name: Check coverage threshold
        if: matrix.python-version == '3.12'
        run: coverage report --fail-under=85

      - name: Check coverage threshold
        id: coverage_threshold_step
        continue-on-error: false
        run: uv run coverage report --fail-under=85

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["python"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Install uv
        uses: astral-sh/setup-uv@v3
      - name: Install dependencies (runtime only)
        run: |
          uv sync
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
